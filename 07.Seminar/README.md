# Selenium

## Пакет Wildberries

Python3 программа по загрузке информации о желаемых товарах с сайта wildberries.ru включает следующие компоненты:

Фреймворки
- selenium

Внешние библиотеки

- json
- csv
- time
- pymongo

Основной стартовый модуль

1. main.py

Внутренние модули

2. scraper
3. selen
4. db
5. tokens


### 1. Стартовый модуль main.py

[Основной скрипт](https://github.com/allseenn/api/blob/main/07.Seminar/main.py) служит для запуска программы из директории, содержащей main.py, в терминале с помощью команд:

```bash MacOS
python3 main.py
```

```pwsh Windows
python main.py
```

```bash Linux
chmod +x main.py
./main.py
```

Программа запросит от пользователя ввода слова, по которому отправит запрос на поиск соответствующих товаров в интернет магазине wildberries.ru. Далее, соберет информацию используя пагинацию, сохранит конечный результат в CSV и JSON файлы, а опционально в базу данных MongoDB.

Формат сохраняемых данных следующий:

- _id - Уникальный артикул товара
- name - Модель товара
- brand - Марка производителя
- price - Цена
- link - Ссылка на страницу с описанием

Имя сохраненного файла будет в виде *товар.json*

Предусмотрено сохранение в базу данных MongoDB, если раскомментировать соответствующую строку в main.py

В процессе работы программы, будет выводится служебная информация в консоль:

```
Введите товар для поиска: Принтер
Page 1 total 105 goods was scraped
Page 2 total 210 goods was scraped
Page 3 total 315 goods was scraped
Page 4 total 420 goods was scraped
Page 5 total 525 goods was scraped
Page 6 total 630 goods was scraped
Page 7 total 735 goods was scraped
Page 8 total 840 goods was scraped
Page 9 total 945 goods was scraped
Page 10 total 1050 goods was scraped
Page 11 total 1155 goods was scraped
Время выполнения: 178.15322017669678 секунд
Всего найдено 1155 товаров
Сохранено в Принтер.json 495 уникальных товаров
```

Большинство ошибок обрабатывается исключениями, позволяя программе продолжать работу, но с выводом неполадки в консоль.

### 2. Модуль scraper.py

[В данном модуле](https://github.com/allseenn/api/blob/main/07.Seminar/wildberries/scraper.py) прописана основная логика работы программы.

Происходит эмуляция взаимодействия браузера с человеком:

- Переход на страницу магазина
- Ввод поискового запроса
- Клик по кнопке "Найти"
- Скроллинг вниз по странице с товарами
- Клик по ссылке "Следующая страница"

Необходимые таймауты выставлены опытным путем.

Пагинация происходит с помощью метода клика по кнопке "Следующая страница".

Процесс продолжается до метки на последней странице. После которого, информация в виде списка словарей передается далее по конвейеру.

### 3. Модуль selen.py

[Модуль](https://github.com/allseenn/api/blob/main/07.Seminar/wildberries/selen.py) включает загрузку необходимых классов и драйвера браузера из фреймворка selenium.

Выставляется режим headless, для скрытого режима работы.

Основным драйвером выбран Mozilla Firefox.

### 4. Модуль db.py

[Модуль](https://github.com/allseenn/api/blob/main/07.Seminar/wildberries/db.py) содержит несколько методов по работе с MongoDB.

- Загрузка данных из MongoDB
- Выгрузка на сервер MongoDB
- Сохранение в JSON-файл
- Сохранение в CSV-файл
- Оптимизация списка товаров

Большинство вышеописанных методов в комментариях не нуждаются. Можно отметить лишь поддержку русскоязычных коллекций в MongoDB, т.е. имена коллекций будут соответствовать поисковому слову.

Особое внимание хочется заострить на последнем методе. По количеству кода он самый маленький, но по объему сохраняемой информации занимает первое место. Благодаря оптимизации, т.е. сохранение только уникальных значений, размер итогового файла уменьшается в несколько раз.

Для наглядности, результат поиска, сохраняется в двух форматах:

1. CSV-файл без оптимизации на уникальность
2. JSON-файл с оптимизацией на уникальность

Открыв файл CSV можно увидеть, что существует большое количество дублирующихся значений, в среднем по 3-4 раза повторяется каждая запись.

В чем же причина такого большого количества дублирующих данных?

Возможно тут причина в маркетинговых целях магазина, дабы показать большой ассортимент, выдаются повторы и складывается впечатление, что у товара (магазина) десятки страниц, по факту единицы.

Еще одной возможной причиной является динамически меняющаяся база. 
Запрос сделанный одним пользователем на сайте в среднем показывает 50 страниц, такой объем информации не будет "вечно" хранится в памяти, т.к. это не эффективно, особенно при миллионных обращениях (просто, не хватит оперативной памяти).
Не все пользователи листают 50 страниц до конца (только скрейперы). Обычно увидев первую страницу, как правило отправляют новый запрос, либо переходят по ссылку в описание понравившегося товара. Следовательно, при переходе на следующую страницу генерируется новый запрос к БД и как следствие за это время данные могли поменяться (цена, наличие, описание, фотографии и т.д.). По сути при переходе на новую страницу у нас "тусуются карты".

Будь это проблема "перетасовки" или "маркетинговая" стратегия - не важно. Главное то, что вопрос решается с помощью уникальных артикулов товара. Чтобы оптимизировать количество полученных данных, применятся функция, которая оставляет только уникальные артикулы.

Если с дублями бороться легко, то с мертвыми ссылками сложнее, на пару порядков меньше, но они есть. 

По хорошему нужно переходить по ссылке и смотреть есть ли товар на странице. Если нет, то продолжать цикл. Если нет, то не включать товар в список. Пока решил данный вопрос с помощью исключений, в результате информация о товаре есть, но без цены.


### 5. tokens.py

Модуль содержит закрытые данные, необходимые для подключения к базе данных MongoDB:

- адрес сервера
- порт
- протокол подключения
- имя пользователя
- пароль
- название базы данных
- название коллекции

## Заключение

В корне решения лежат два примера, каждый из которых содержит не оптимизированный CSV-файл и оптимизированный JSON-файл:

1. Результат по запросу "Неттоп":
- [CSV: 360 записей](https://github.com/allseenn/api/blob/main/07.Seminar/%D0%9D%D0%B5%D1%82%D1%82%D0%BE%D0%BF.csv)
- [JSON: 90 записей](https://github.com/allseenn/api/blob/main/07.Seminar/%D0%9D%D0%B5%D1%82%D1%82%D0%BE%D0%BF.json)

2. Результат по запросу "Рация":
- [CSV:  5400 записей](https://github.com/allseenn/api/blob/main/07.Seminar/%D0%A0%D0%B0%D1%86%D0%B8%D1%8F.csv)
- [JSON: 1038 записей](https://raw.githubusercontent.com/allseenn/api/main/07.Seminar/%D0%A0%D0%B0%D1%86%D0%B8%D1%8F.json)