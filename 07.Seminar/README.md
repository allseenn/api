# Selenium

## Пакет Wildberries

Python3 программа по загрузке информации о желаемых товарах с сайта wildberries.ru включает следующие компоненты:

Фреймворки
- selenium

Внешние библиотеки

- json
- time
- pymongo

Основной стартовый модуль

1. main.py

Внутренние модули

2. scraper
3. selen
4. db
5. tokens


### 1. Стартовый модуль main.py

[Основной скрипт](https://github.com/allseenn/api/blob/main/07.Seminar/main.py) служит для запуска программы из директории, содержащей main.py, в терминале с помощью команд:

```bash MacOS
python3 main.py
```

```pwsh Windows
python main.py
```

```bash Linux
chmod +x main.py
./main.py
```

Программа запросит от пользователя ввода слова, по которому отправит запрос на поиск соответствующих товаров в интернет магазине wildberries.ru. Далее, соберет информацию используя пагинацию, сохранит конечный результат в JSON-файл или в базу данных MongoDB.

Формат сохраняемых данных следующий:

- _id - Уникальный артикул товара
- name - Модель товара
- brand - Марка производителя
- price - Цена
- link - Ссылка на страницу с описанием

Имя сохраненного файла будет в виде *товар.json*

Предусмотрено сохранение в базу данных MongoDB, если раскомментировать соответствующую строку в main.py

В процессе работы программы, будет выводится служебная информация в консоль:

```
Введите товар для поиска: Принтер
Page 1 total 105 goods was scraped
Page 2 total 210 goods was scraped
Page 3 total 315 goods was scraped
Page 4 total 420 goods was scraped
Page 5 total 525 goods was scraped
Page 6 total 630 goods was scraped
Page 7 total 735 goods was scraped
Page 8 total 840 goods was scraped
Page 9 total 945 goods was scraped
Page 10 total 1050 goods was scraped
Page 11 total 1155 goods was scraped
Время выполнения: 178.15322017669678 секунд
Всего найдено 1155 товаров
Сохранено в Принтер.json 495 уникальных товаров
```

Большинство ошибок обрабатывается исключениями, позволяя программе продолжать работу, но с выводом неполадки в консоль.

### 2. Модуль scraper.py

[В данном модуле](https://github.com/allseenn/api/blob/main/07.Seminar/wildberries/scraper.py) прописана основная логика работы программы.

В ней описаны действия эмулирующие взаимодействие браузера с человеком.

- Переход на страницу магазина
- Ввод поискового запроса
- Клик по кнопке "Найти"
- Скроллинг вниз по странице с товарами
- Клик по ссылке "Следующая страница"

Необходимые таймауты выставлены опытным путем.

Не всегда срабатывает клик по ссылке "Следующая страница", поэтому происходит контроль загруженного товара. Если товара больше нет на странице, то подразумевается что достигнут конец.

### 3. Модуль selen.py

[Модуль](https://github.com/allseenn/api/blob/main/07.Seminar/wildberries/selen.py) включает загрузку необходимых классов и драйвера браузера из фреймворка selenium.

Выставляется режим headless, для скрытого режима работы.

Основным драйвером выбран Mozilla Firefox.

### 4. Модуль db.py

[Модуль](https://github.com/allseenn/api/blob/main/07.Seminar/wildberries/db.py) содержит несколько методов по работе с MongoDB.

- Загрузка данных из MongoDB
- Выгрузка на сервер MongoDB
- Создание уникального списка товаров

Поддерживается создание русскоязычных коллекции MongoDB, соответствующих поисковому слову.
Т.к. при загрузке данных в процессе работы scraper.py собираются дублирующиеся данные, то необходимо их оптимизировать.
Дублирование происходит по двум основным причинам:

1. В следствии двойного парсинга
2. В следствии повторяющихся товаров на самом сайте wildberries

#### 4.1. Двойной парсинг

В силу того, что информация о товарах подгружается постепенно, вместе с прокруткой страницы, то парсеру не известно точное их количество.
Более того, просмотренные товары, ушедшие вверх вместе с прокруткой, исчезают со страницы. 
Количество загруженных товаров в "порциях"  всегда разное. Поэтому, парсер берет столько записей, сколько видит, на конкретной период времени и может захватывать как части впереди и позади идущих товаров.

#### 4.2. Повторяющиеся товары

Замечено, что некоторые товары, появляются в запросе дважды. Возможно в маркетинговых целях, а возможно в результате динамически меняющейся базы. 
Запрос сделанный одним пользователем на сайте и включающий 50 страниц, не будет вечно хранится в памяти, т.к. это не эффективно, особенно при миллионных обращениях (просто, не хватит оперативной памяти).
Не все пользователи листают 50 страниц до конца (только скрейперы). Обычно увидев первую страницу, как правило задают новый запрос, либо переходят по ссылку в описание понравившегося товара. Следовательно, при переходе на следующую страницу генерируется новый запрос к БД и как следствие за это время данные могли поменяться (цена, наличие, описание, фотографии и т.д.). По сути при переходе на новую страницу у нас "тусуются карты".

Проблемы двойного парсинга и "перетусовки" решается, с помощью уникальных артикулов товара. Чтобы оптимизировать количество полученных данных, применятся функция, которая оставляет только уникальные артикулы.

### 5. tokens.py

Модуль содержит закрытые данные, необходимые для подключения к базе данных MongoDB:

- адрес сервера
- порт
- протокол подключения
- имя пользователя
- пароль
- название базы данных
- название коллекции

## Заключение

В корне решения лежат два json-файла, как пример результатов поиска по соответствующих их именам запросам:

- [Дрель](https://raw.githubusercontent.com/allseenn/api/main/07.Seminar/%D0%94%D1%80%D0%B5%D0%BB%D1%8C.json)
- [Принтер](https://raw.githubusercontent.com/allseenn/api/main/07.Seminar/%D0%9F%D1%80%D0%B8%D0%BD%D1%82%D0%B5%D1%80.json)